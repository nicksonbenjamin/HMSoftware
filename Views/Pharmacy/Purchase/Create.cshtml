@model ClinicApp.ViewModels.PurchaseViewModel
@{
    ViewData["Title"] = "Create Purchase";
}

<h4>Create Purchase</h4>

<form asp-action="Create" method="post">

    <!-- Header -->
    <div class="row mb-3">
        <div class="col-md-3">
            <label>Purchase No</label>
            <input asp-for="PurchaseNo" class="form-control" readonly />
        </div>
        <div class="col-md-3">
            <label>Purchase Date</label>
            <input asp-for="PurchaseDate" type="date" class="form-control" />
        </div>
        <div class="col-md-3">
            <label>Supplier</label>
            <select asp-for="SupplierId" asp-items="Model.SupplierList" class="form-control"></select>
        </div>
        <div class="col-md-3">
            <label>Supplier Invoice No</label>
            <input asp-for="SupplierInvoiceNo" class="form-control" />
        </div>
    </div>

    <hr />

    <!-- Items -->
    <h6>Purchase Items</h6>

    <table class="table table-bordered table-sm" id="itemsTable">
        <thead class="thead-light">
            <tr>
                <th>Product</th>
                <th width="70">Qty</th>
                <th width="90">Rate</th>
                <th width="90">MRP</th>
                <th width="90">Disc %</th>
                <th width="70">Tax %</th>
                <th width="110">Net</th>
                <th width="70"></th>
            </tr>
        </thead>
        <tbody>
        @for (int i = 0; i < Model.Items.Count; i++)
        {
            <tr>
                <td>
                    <select asp-for="Items[i].ProductId" asp-items="Model.ProductList" class="form-control"></select>
                </td>
                <td><input asp-for="Items[i].Qty" class="form-control calc qty" /></td>
                <td><input asp-for="Items[i].Rate" class="form-control calc rate" /></td>
                <td><input asp-for="Items[i].MRP" class="form-control" /></td>
                <td><input asp-for="Items[i].DiscountPercent" class="form-control calc disc" /></td>
                <td><input asp-for="Items[i].TaxPercent" class="form-control calc tax" /></td>
                <td><input asp-for="Items[i].NetAmount" class="form-control net" readonly /></td>
                <td class="text-center">
                    <button type="button" class="btn btn-danger btn-sm remove">×</button>
                </td>
            </tr>
        }
        </tbody>
    </table>

    <button type="button" id="addItemBtn" class="btn btn-warning btn-sm mb-3">+ Add Item</button>

    <hr />

    <!-- Totals -->
    <div class="row text-right mb-3">
        <div class="col-md-2">
            <label>Total Qty</label>
            <input asp-for="TotalQty" class="form-control" readonly />
        </div>
        <div class="col-md-2">
            <label>Total Amt</label>
            <input asp-for="TotalAmount" class="form-control" readonly />
        </div>
        <div class="col-md-2">
            <label>Discount</label>
            <input asp-for="TotalDiscount" class="form-control" readonly />
        </div>
        <div class="col-md-2">
            <label>Tax</label>
            <input asp-for="TotalTax" class="form-control" readonly />
        </div>
        <div class="col-md-2">
            <label>Round Off</label>
            <input asp-for="RoundOff" class="form-control" />
        </div>
        <div class="col-md-2">
            <label>Net</label>
            <input asp-for="NetAmount" class="form-control" readonly />
        </div>
    </div>

    <div class="mb-3">
        <label>Remarks</label>
        <textarea asp-for="Remarks" rows="2" class="form-control"></textarea>
    </div>

    <button type="submit" class="btn btn-primary">Save</button>
</form>

@section Scripts {
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const productOptions = `@Html.Raw(string.Join("", Model.ProductList.Select(p => $"<option value='{p.Value}'>{p.Text}</option>")))`;

    function calcRow(row) {
        let q = +row.find('.qty').val() || 0,
            r = +row.find('.rate').val() || 0,
            d = +row.find('.disc').val() || 0,
            t = +row.find('.tax').val() || 0;

        let amt = q * r,
            disc = amt * d / 100,
            tax = (amt - disc) * t / 100,
            net = amt - disc + tax;

        row.find('.net').val(net.toFixed(2));
        return { q, amt, disc, tax, net };
    }

    function calcTotals() {
        let T = { q:0, amt:0, disc:0, tax:0, net:0 };

        $('#itemsTable tbody tr').each(function () {
            let r = calcRow($(this));
            Object.keys(T).forEach(k => T[k] += r[k]);
        });

        let round = +$('input[name="RoundOff"]').val() || 0;

        $('input[name="TotalQty"]').val(T.q.toFixed(2));
        $('input[name="TotalAmount"]').val(T.amt.toFixed(2));
        $('input[name="TotalDiscount"]').val(T.disc.toFixed(2));
        $('input[name="TotalTax"]').val(T.tax.toFixed(2));
        $('input[name="NetAmount"]').val((T.net + round).toFixed(2));
    }

    $('#addItemBtn').click(() => {
        let i = $('#itemsTable tbody tr').length;
        $('#itemsTable tbody').append(`
            <tr>
                <td><select name="Items[${i}].ProductId" class="form-control">${productOptions}</select></td>
                <td><input name="Items[${i}].Qty" class="form-control calc qty" /></td>
                <td><input name="Items[${i}].Rate" class="form-control calc rate" /></td>
                <td><input name="Items[${i}].MRP" class="form-control" /></td>
                <td><input name="Items[${i}].DiscountPercent" class="form-control calc disc" /></td>
                <td><input name="Items[${i}].TaxPercent" class="form-control calc tax" /></td>
                <td><input name="Items[${i}].NetAmount" class="form-control net" readonly /></td>
                <td class="text-center"><button type="button" class="btn btn-danger btn-sm remove">×</button></td>
            </tr>`);
    });

    $(document).on('input', '.calc, input[name="RoundOff"]', calcTotals);
    $(document).on('click', '.remove', function () {
        $(this).closest('tr').remove();
        calcTotals();
    });

    calcTotals();
</script>
}
