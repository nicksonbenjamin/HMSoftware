@model ClinicApp.ViewModels.PurchaseViewModel
@{
    ViewData["Title"] = "Edit Purchase";

    var productOptionsHtml = string.Join("",
        Model.ProductList.Select(p =>
            $"<option value='{p.Value}'>{p.Text}</option>"));
}

<h2>Edit Purchase</h2>

<form asp-action="Edit" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="PurchaseId" />

    <!-- HEADER -->
    <div class="row mb-3">
        <div class="col-md-3">
            <label>Purchase No</label>
            <input asp-for="PurchaseNo" class="form-control" readonly />
        </div>
        <div class="col-md-3">
            <label>Date</label>
            <input asp-for="PurchaseDate" type="date" class="form-control" />
        </div>
        <div class="col-md-6">
            <label>Supplier</label>
            <select asp-for="SupplierId" class="form-select" asp-items="Model.SupplierList">
                <option value="">-- Select --</option>
            </select>
        </div>
    </div>

    <!-- ITEMS TABLE -->
    <table class="table table-bordered" id="itemsTable">
        <thead class="table-primary">
            <tr>
                <th>Product</th>
                <th>Batch</th>
                <th>Exp</th>
                <th>UOM</th>
                <th>Qty</th>
                <th>Free</th>
                <th>Rate</th>
                <th>MRP</th>
                <th>Disc%</th>
                <th>Tax%</th>
                <th>Net</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        @for (int i = 0; i < Model.Items.Count; i++)
        {
            <tr>
                <td>
                    <select name="Items[@i].ProductId" class="form-select">
                        <option value="">--Select--</option>
                        @foreach (var p in Model.ProductList)
                        {
                            <option value="@p.Value"
                                    selected="@(p.Value == Model.Items[i].ProductId.ToString())">
                                @p.Text
                            </option>
                        }
                    </select>
                </td>
                <td><input name="Items[@i].BatchNo" value="@Model.Items[i].BatchNo" class="form-control" /></td>
                <td><input type="date" name="Items[@i].ExpiryDate" value="@(Model.Items[i].ExpiryDate?.ToString("yyyy-MM-dd"))" class="form-control" /></td>
                <td><input name="Items[@i].UOM" value="@Model.Items[i].UOM" class="form-control" readonly /></td>
                <td><input name="Items[@i].Qty" value="@Model.Items[i].Qty" class="form-control" /></td>
                <td><input name="Items[@i].FreeQty" value="@Model.Items[i].FreeQty" class="form-control" /></td>
                <td><input name="Items[@i].Rate" value="@Model.Items[i].Rate" class="form-control" /></td>
                <td><input name="Items[@i].MRP" value="@Model.Items[i].MRP" class="form-control" /></td>
                <td><input name="Items[@i].DiscountPercent" value="@Model.Items[i].DiscountPercent" class="form-control" /></td>
                <td><input name="Items[@i].TaxPercent" value="@Model.Items[i].TaxPercent" class="form-control" /></td>
                <td><input name="Items[@i].NetAmount" value="@Model.Items[i].NetAmount" class="form-control" readonly /></td>
                <td><button type="button" class="btn btn-danger remove">×</button></td>
            </tr>
        }
        </tbody>
    </table>

    <button type="button" id="addRow" class="btn btn-primary">+ Add</button>
    <br /><br />

    <button type="submit" class="btn btn-success">Save</button>
    <a asp-action="Index" class="btn btn-secondary">Cancel</a>
</form>

@section Scripts {
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var productOptions = `@Html.Raw(productOptionsHtml)`;

    $('#addRow').click(function () {
        var i = $('#itemsTable tbody tr').length;
        $('#itemsTable tbody').append(`
        <tr>
            <td><select name="Items[${i}].ProductId" class="form-select"><option value="">--Select--</option>${productOptions}</select></td>
            <td><input name="Items[${i}].BatchNo" class="form-control" /></td>
            <td><input type="date" name="Items[${i}].ExpiryDate" class="form-control" /></td>
            <td><input name="Items[${i}].UOM" class="form-control" readonly /></td>
            <td><input name="Items[${i}].Qty" class="form-control" /></td>
            <td><input name="Items[${i}].FreeQty" class="form-control" /></td>
            <td><input name="Items[${i}].Rate" class="form-control" /></td>
            <td><input name="Items[${i}].MRP" class="form-control" /></td>
            <td><input name="Items[${i}].DiscountPercent" class="form-control" /></td>
            <td><input name="Items[${i}].TaxPercent" class="form-control" /></td>
            <td><input name="Items[${i}].NetAmount" class="form-control" readonly /></td>
            <td><button type="button" class="btn btn-danger remove">×</button></td>
        </tr>`);
    });

    $(document).on('click', '.remove', function () {
        $(this).closest('tr').remove();
    });
</script>
}
