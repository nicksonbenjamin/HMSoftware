@model ClinicApp.ViewModels.PatientRegistrationViewModel

@* Reuse Create.cshtml styling *@
<style>
  .reg-container { border: 1px solid #ccc; padding: 10px; background: #fafafa; }
  .reg-title { font-size: 15px; font-weight: bold; margin-bottom: 6px; background: #e8eff6; padding: 5px 8px; border-bottom: 1px solid #c5d0da; }
  .reg-form label { font-size: 12px; font-weight: 600; margin-bottom: 2px; }
  .reg-form input, .reg-form select, .reg-form textarea { height: 26px !important; padding: 2px 4px !important; font-size: 12px !important; border-radius: 0 !important; }
  textarea { height: 40px !important; }
  .row { margin-bottom: 4px; }
  .photo-box { width: 90px; height: 110px; border: 1px dashed #888; background-size: cover; background-position: center; }
  #webcam { width: 120px; height: 100px; border: 1px solid #444; margin-top: 5px; }
  .btn-sm { padding: 2px 8px !important; font-size: 12px !important; border-radius: 2px; }
  .save-section { text-align: right; margin-top: 10px; border-top: 1px solid #ddd; padding-top: 8px; }
</style>

<div class="reg-container">
  <div class="reg-title">Edit Patient</div>

  <form asp-action="Edit" method="post" class="reg-form">
    <input type="hidden" asp-for="PatientId" />

    <div class="row">
      <div class="col-md-6" style="border-right: 1px solid #ccc;">
        @* Left side fields *@
        <div class="row">
          <div class="col-4"><label>UHID Type</label><select asp-for="UHIDType" asp-items="Model.UHIDTypes" class="form-select"></select></div>
          <div class="col-4"><label>UHID No</label><input asp-for="UHIDNo" class="form-control" /></div>
          <div class="col-4"><label>Date</label><input asp-for="RegistrationDate" type="date" class="form-control" /></div>
        </div>

        <div class="row">
          <div class="col-3"><label>Time</label><input asp-for="RegistrationTime" type="time" class="form-control" /></div>
          <div class="col-3"><label>Sex</label><select asp-for="Sex" asp-items="Model.Sexes" class="form-select"></select></div>
          <div class="col-3"><label>Title</label><select asp-for="PatientTitle" asp-items="Model.PatientTitles" class="form-select"></select></div>
          <div class="col-3"><label>DOB</label><input asp-for="DOB" type="date" class="form-control" /></div>
        </div>

        <div class="row">
          <div class="col-8"><label>Patient Name*</label><input asp-for="PatientName" class="form-control" /></div>
          <div class="col-4"><label>Age</label><input asp-for="Age" type="number" class="form-control" /></div>
        </div>

        <div class="row">
          <div class="col-3"><label>Guardian</label><select asp-for="GuardianTitle" asp-items="Model.GuardianTitles" class="form-select"></select></div>
          <div class="col-9"><label>Guardian Name</label><input asp-for="Guardian" class="form-control" /></div>
        </div>

        <div class="row">
          <div class="col-12"><label>Address</label><textarea asp-for="Address" class="form-control"></textarea></div>
        </div>

        <div class="row">
          <div class="col-4"><label>Place</label><input asp-for="Place" class="form-control" /></div>
          <div class="col-4"><label>District</label><input asp-for="District" class="form-control" /></div>
          <div class="col-4"><label>GST State</label><select asp-for="GSTState" asp-items="Model.GSTStates" class="form-select"></select></div>
        </div>

        <div class="row">
          <div class="col-4"><label>Country</label><select asp-for="Country" asp-items="Model.Countries" class="form-select"></select></div>
          <div class="col-4"><label>Pin Code</label><input asp-for="PinCode" class="form-control" /></div>
          <div class="col-4"><label>Mobile No*</label><input asp-for="MobileNo" class="form-control" /></div>
        </div>
      </div>

      <div class="col-md-6">
        @* Right side fields *@
        <div class="row">
          <div class="col-6"><label>Email</label><input asp-for="Email" class="form-control" /></div>
          <div class="col-6"><label>Occupation</label><input asp-for="Occupation" class="form-control" /></div>
        </div>

        <div class="row">
          <div class="col-4"><label>Marital Status</label><select asp-for="MaritalStatus" asp-items="Model.MaritalStatuses" class="form-select"></select></div>
          <div class="col-4"><label>B.Group</label><select asp-for="BloodGroup" asp-items="Model.BloodGroups" class="form-select"></select></div>
          <div class="col-4"><label>Allergic To</label><input asp-for="AllergicTo" class="form-control" /></div>
        </div>

        <div class="row">
          <div class="col-6"><label>Consultant Doctor*</label><select asp-for="ConsultantDoctorId" asp-items="Model.ConsultantDoctors" class="form-select"></select></div>
          <div class="col-6"><label>Ref Doctor</label><select asp-for="RefDoctorId" asp-items="Model.RefDoctors" class="form-select"></select></div>
        </div>

        <div class="row">
          <div class="col-4"><label>Payment Terms</label><select asp-for="PaymentTerms" asp-items="Model.PaymentTermsList" class="form-select"></select></div>
          <div class="col-4"><label>Reg Type</label><select asp-for="RegistrationType" asp-items="Model.RegistrationTypes" class="form-select"></select></div>
          <div class="col-4"><label>Comp/Ins/Camp</label><select asp-for="CompOrInsOrCamp" asp-items="Model.CompInsCampList" class="form-select"></select></div>
        </div>

        <div class="row">
          <div class="col-6"><label>Patient Condition</label><input asp-for="PatientCondition" class="form-control" /></div>
          <div class="col-6"><label>Reference/PICME No</label><input asp-for="ReferenceOrPicmeNo" class="form-control" /></div>
        </div>

        @* Webcam and photo capture *@
        <div class="row mt-2">
          <div class="col-6">
            <label>Photo</label><br />
            <button type="button" id="startWebcamBtn" class="btn btn-info btn-sm">Start Webcam</button>
            <button type="button" id="captureBtn" class="btn btn-primary btn-sm ms-1">Retake Photo</button>
            <input type="hidden" asp-for="PhotoBase64" id="PhotoBase64" />
            <input type="text" asp-for="PhotoFileName" readonly class="form-control form-control-sm mt-1" />
            <video id="webcam" autoplay style="display: none;"></video>
          </div>
          <div class="col-6 d-flex align-items-center justify-content-center">
            <div id="photoPreviewBox" class="photo-box"></div>
          </div>
        </div>

        @* Display saved photo *@
        <div class="row mt-2">
          <div class="col-12">
            <label>Photo Preview</label>
            @if (!string.IsNullOrEmpty(Model.PhotoBase64))
            {
                <img src="data:image/png;base64,@Model.PhotoBase64" alt="Patient Photo" width="150" />
            }
          </div>
        </div>

        <div class="row mt-1">
          <div class="col-12 d-flex align-items-center">
            <input asp-for="IsActive" class="form-check-input" />
            <label class="ms-1">Active</label>
          </div>
        </div>
      </div>
    </div>

    <div class="save-section">
      <button class="btn btn-success btn-sm px-3">Save</button>
      <a asp-action="Index" class="btn btn-secondary btn-sm px-3 ms-1">Cancel</a>
    </div>
  </form>
</div>

<script>
  let webcamStream;

  document.getElementById("startWebcamBtn").addEventListener("click", async () => {
    const video = document.getElementById("webcam");
    video.style.display = "block";
    webcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = webcamStream;
  });

  document.getElementById("captureBtn").addEventListener("click", () => {
    const video = document.getElementById("webcam");
    const canvas = document.createElement("canvas");
    canvas.width = 120;
    canvas.height = 100;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = canvas.toDataURL("image/png");

    // Remove data:image prefix before storing in DB
    document.getElementById("PhotoBase64").value = imageData.split(",")[1];

    const now = new Date();
    const filename = `Captured_${now.getFullYear()}_${String(now.getMonth()+1).padStart(2,'0')}_${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}.png`;
    document.querySelector("input[name='PhotoFileName']").value = filename;

    document.getElementById("photoPreviewBox").style.backgroundImage = `url(${imageData})`;
    video.style.display = "none";

    if (webcamStream) {
      webcamStream.getTracks().forEach(track => track.stop());
    }
  });

  window.addEventListener("DOMContentLoaded", function() {
    const base64 = document.getElementById("PhotoBase64").value;
    if (base64) {
      document.getElementById("photoPreviewBox").style.backgroundImage = `url(data:image/png;base64,${base64})`;
    }
  });
</script>
