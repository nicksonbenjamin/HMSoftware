@model ClinicApp.ViewModels.DoctorPrescriptionVM
@using ClinicApp.Models

@{
    ViewData["Title"] = "Create Prescription";

    var entryNumber = DateTime.Now.ToString("yyyyMMddHHmmss");

    var today = DateTime.Today;
    int startYear, endYear;

    if (today.Month >= 4)
    {
        startYear = today.Year % 100;
        endYear = (today.Year + 1) % 100;
    }
    else
    {
        startYear = (today.Year - 1) % 100;
        endYear = today.Year % 100;
    }

    var entryPeriod = $"{startYear:D2}-{endYear:D2}";
}

/* --------------------------------------------
   PRE-BUILD HTML OPTIONS FOR JAVASCRIPT ROWS
   -------------------------------------------- */
@{
    string medicineOptions = "";
    foreach (var m in Model.MedicineList)
    {
        medicineOptions += $"<option value='{m.ProductCode}'>{m.ProductName}</option>";
    }

    string dosePatternOptions = "";
    foreach (var dp in Model.DosePatternList)
    {
        dosePatternOptions += $"<option value='{dp.DosePatternId}'>{dp.DoseDescription}</option>";
    }
}

<style>
    .title-bar {
        background: #1c4e80; color: white;
        padding: 6px 10px; font-size: 16px;
        border-radius: 4px; margin-bottom: 12px;
    }
    .section-block {
        border: 1px solid #ddd; padding: 10px;
        border-radius: 4px; background: #fafafa;
        margin-bottom: 15px;
    }
    .section-title {
        font-weight: bold; color: #1c4e80;
        margin-bottom: 8px;
    }
    .form-control { height: 26px; padding: 2px 5px; font-size: 12px; }
    table.table { font-size: 12px; }
    table td, table th { padding: 4px; }
</style>

<div class="title-bar">Create Prescription</div>

<form asp-action="Save" method="post">

    <!-- PATIENT INFO -->
    <div class="section-block">
        <div class="section-title">Patient Details</div>

        <div class="row">

            <div class="col-md-3">
                <label>Patient</label>
                <select asp-for="Prescription.PatientId"
                        asp-items="@(new SelectList(Model.PatientList, "PatientId", "PatientName"))"
                        class="form-control">
                    <option value="">-- Select Patient --</option>
                </select>
            </div>

            <div class="col-md-2">
                <label>Entry Type</label>
                <input asp-for="Prescription.EntryType" class="form-control" />
            </div>

            <div class="col-md-2">
                <label>Entry Number</label>
                <input asp-for="Prescription.EntryNumber" class="form-control" value="@entryNumber" readonly />
            </div>

            <div class="col-md-2">
                <label>Entry Period</label>
                <input asp-for="Prescription.EntryPeriod" class="form-control" value="@entryPeriod" readonly />
            </div>

            <div class="col-md-3">
                <label>Disease</label>
                <input list="diseaseList" name="Prescription.DeseaseId" class="form-control" />
                <datalist id="diseaseList">
                    @foreach (var d in Model.DiseaseList)
                    {
                        <option value="@d.DeseaseId">@d.DeseaseDetails</option>
                    }
                </datalist>
            </div>

        </div>
    </div>

    <!-- VITALS -->
    <div class="section-block">
        <div class="section-title">Vitals</div>

        <div class="row">

            <div class="col-md-2"><label>Height</label><input asp-for="Prescription.Height" class="form-control" /></div>
            <div class="col-md-2"><label>Weight</label><input asp-for="Prescription.Weight" class="form-control" /></div>
            <div class="col-md-2"><label>BMI</label><input asp-for="Prescription.BMI" class="form-control" /></div>
            <div class="col-md-2"><label>Temp</label><input asp-for="Prescription.TempInCelcius" class="form-control" /></div>
            <div class="col-md-2"><label>BP</label><input asp-for="Prescription.BP" class="form-control" /></div>
            <div class="col-md-2"><label>SPO2</label><input asp-for="Prescription.SPO2" class="form-control" /></div>
            <div class="col-md-2"><label>Pulse</label><input asp-for="Prescription.PulseRate" class="form-control" /></div>
            <div class="col-md-3"><label>Next Visit</label>
                <input asp-for="Prescription.NextVisitDate" type="date" class="form-control" />
            </div>

        </div>
    </div>

    <!-- MEDICINES -->
    <div class="section-block">
        <div class="section-title">Medicine List</div>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Medicine</th>
                    <th>Dose Pattern</th>
                    <th>Usage</th>
                    <th>Days</th>
                    <th>Qty</th>
                    <th width="40">#</th>
                </tr>
            </thead>
            <tbody id="medicineRows">

                @for (int i = 0; i < (Model.Medicines?.Count ?? 1); i++)
                {
                    <tr>
                        <td>
                            <select name="Medicines[@i].ProductId" class="form-control">
                                <option value="">-- Select --</option>
                                @foreach (var m in Model.MedicineList)
                                {
                                    <option value="@m.ProductCode"
                                            selected="@(Model.Medicines?[i]?.ProductId == m.ProductCode)">
                                        @m.ProductName
                                    </option>
                                }
                            </select>
                        </td>

                        <td>
                            <select name="Medicines[@i].DosePatternId" class="form-control">
                                <option value="">-- Select --</option>
                                @foreach (var dp in Model.DosePatternList)
                                {
                                    <option value="@dp.DosePatternId"
                                            selected="@(Model.Medicines?[i]?.DosePatternId == dp.DosePatternId)">
                                        @dp.DoseDescription
                                    </option>
                                }
                            </select>
                        </td>

                        <td><input name="Medicines[@i].DoseUsage" class="form-control" value="@Model.Medicines?[i]?.DoseUsage" /></td>
                        <td><input name="Medicines[@i].DoseDays" type="number" class="form-control" value="@Model.Medicines?[i]?.DoseDays" /></td>
                        <td><input name="Medicines[@i].Qty" type="number" class="form-control" value="@Model.Medicines?[i]?.Qty" /></td>

                        <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">X</button></td>
                    </tr>
                }

            </tbody>
        </table>

        <button type="button" class="btn btn-success btn-sm" onclick="addMedicine()">+ Add Medicine</button>
    </div>

    <!-- CLINICAL DETAILS -->
    <div class="section-block">
        <div class="section-title">Clinical Notes</div>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Result</th>
                    <th width="40">#</th>
                </tr>
            </thead>
            <tbody id="clinicalRows">
                <tr>
                    <td><input name="Clinical[0].ClinicalNote" class="form-control" /></td>
                    <td><input name="Clinical[0].Result" class="form-control" /></td>
                    <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">X</button></td>
                </tr>
            </tbody>
        </table>

        <button type="button" class="btn btn-success btn-sm" onclick="addClinical()">+ Add Clinical</button>
    </div>

    <button type="submit" class="btn btn-primary btn-lg">Save</button>

</form>

<script>
    function removeRow(btn) {
        btn.closest("tr").remove();
    }

    function addMedicine() {
        let index = document.querySelectorAll("#medicineRows tr").length;

        let row = `
        <tr>
            <td>
                <select name="Medicines[${index}].ProductId" class="form-control">
                    <option value="">-- Select --</option>
                    @Html.Raw(medicineOptions)
                </select>
            </td>

            <td>
                <select name="Medicines[${index}].DosePatternId" class="form-control">
                    <option value="">-- Select --</option>
                    @Html.Raw(dosePatternOptions)
                </select>
            </td>

            <td><input name="Medicines[${index}].DoseUsage" class="form-control" /></td>
            <td><input name="Medicines[${index}].DoseDays" type="number" class="form-control" /></td>
            <td><input name="Medicines[${index}].Qty" type="number" class="form-control" /></td>

            <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">X</button></td>
        </tr>`;

        document.getElementById("medicineRows").insertAdjacentHTML("beforeend", row);
    }

    function addClinical() {
        let index = document.querySelectorAll("#clinicalRows tr").length;

        let row = `
        <tr>
            <td><input name="Clinical[${index}].ClinicalNote" class="form-control" /></td>
            <td><input name="Clinical[${index}].Result" class="form-control" /></td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">X</button></td>
        </tr>`;

        document.getElementById("clinicalRows").insertAdjacentHTML("beforeend", row);
    }
</script>
