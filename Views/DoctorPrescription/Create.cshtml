@model ClinicApp.ViewModels.DoctorPrescriptionVM
@using ClinicApp.Models

@{
    ViewData["Title"] = "Create Prescription";

    // Auto-generate Entry Number (example logic: current timestamp)
    var entryNumber = DateTime.Now.ToString("yyyyMMddHHmmss");

    // Auto-calculate financial year for EntryPeriod
    var today = DateTime.Today;
    int startYear, endYear;

    if (today.Month >= 4) // April to December
    {
        startYear = today.Year % 100; // last two digits
        endYear = (today.Year + 1) % 100;
    }
    else // January to March
    {
        startYear = (today.Year - 1) % 100;
        endYear = today.Year % 100;
    }

    var entryPeriod = $"{startYear:D2}-{endYear:D2}";
}

<style>
    .title-bar {
        background: #1c4e80;
        color: white;
        padding: 5px 8px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 4px;
        margin-bottom: 8px;
    }

    .section-block {
        border: 1px solid #dcdcdc;
        padding: 8px;
        margin-bottom: 8px;
        border-radius: 4px;
        background: #fafafa;
        box-shadow: 0px 1px 1px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        font-weight: bold;
        font-size: 13px;
        margin-bottom: 6px;
        color: #1c4e80;
    }

    label {
        font-weight: 600;
        margin-bottom: 1px;
        font-size: 12px;
    }

    .form-control {
        padding: 3px 5px;
        height: 26px;
        font-size: 12px;
    }

    .btn-small, .btn-sm {
        padding: 1px 4px;
        font-size: 11px;
    }

    table.table {
        margin-bottom: 5px;
        font-size: 12px;
    }

    .grid-table th, .grid-table td {
        padding: 2px 4px;
        font-size: 12px;
        vertical-align: middle;
    }

    .grid-table th {
        text-align: center;
    }
</style>

<div class="title-bar">Create Prescription</div>

<form asp-action="Save" method="post">

    <!-- ===================== Patient + Info Section ===================== -->
    <div class="section-block">
        <div class="section-title">Patient Details</div>
        <div class="row">
            <div class="col-md-3">
                <label>Patient</label>
                <select asp-for="Prescription.PatientId"
                        asp-items="@(new SelectList(Model.PatientList, "PatientId", "PatientName"))"
                        class="form-control">
                    <option value="">-- Select Patient --</option>
                </select>
            </div>

            <div class="col-md-3">
                <label>Entry Type</label>
                <input asp-for="Prescription.EntryType" class="form-control" />
            </div>

            <div class="col-md-2">
                <label>Entry Number</label>
                <input asp-for="Prescription.EntryNumber" class="form-control" value="@entryNumber" readonly />
            </div>

            <div class="col-md-2">
                <label>Entry Period</label>
                <input asp-for="Prescription.EntryPeriod" class="form-control" value="@entryPeriod" readonly />
            </div>

            <div class="col-md-2">
                <label>Disease</label>
                <input list="diseaseList" name="Prescription.DeseaseId" class="form-control" />
                <datalist id="diseaseList">
                    @foreach (var d in Model.DiseaseList)
                    {
                        <option value="@d.DeseaseId">@d.DeseaseDetails</option>
                    }
                </datalist>
            </div>
        </div>
    </div>

    <!-- ===================== Vitals Section ===================== -->
    <div class="section-block">
        <div class="section-title">Vitals</div>
        <div class="row">
            <div class="col-md-2">
                <label>Height (cm)</label>
                <input asp-for="Prescription.Height" class="form-control" />
            </div>

            <div class="col-md-2">
                <label>Weight (kg)</label>
                <input asp-for="Prescription.Weight" class="form-control" />
            </div>

            <div class="col-md-2">
                <label>BMI</label>
                <input asp-for="Prescription.BMI" class="form-control" />
            </div>

            <div class="col-md-2">
                <label>Temp (Â°C)</label>
                <input asp-for="Prescription.TempInCelcius" class="form-control" />
            </div>

            <div class="col-md-2">
                <label>BP</label>
                <input asp-for="Prescription.BP" class="form-control" />
            </div>

            <div class="col-md-2">
                <label>SPO2</label>
                <input asp-for="Prescription.SPO2" class="form-control" />
            </div>

            <div class="col-md-2">
                <label>Pulse</label>
                <input asp-for="Prescription.PulseRate" class="form-control" />
            </div>

            <div class="col-md-3">
                <label>Next Visit</label>
                <input asp-for="Prescription.NextVisitDate" type="date" class="form-control" />
            </div>
        </div>
    </div>

    <!-- ===================== Medicines Section ===================== -->
    <div class="section-block">
        <div class="section-title">Medicines</div>
        <table class="table table-bordered grid-table">
            <thead>
                <tr>
                    <th>Medicine</th>
                    <th>Dose Pattern</th>
                    <th>Usage</th>
                    <th>Days</th>
                    <th>Qty</th>
                    <th width="50">#</th>
                </tr>
            </thead>
            <tbody id="medicineRows">
                @for (int i = 0; i < (Model.Medicines?.Count ?? 1); i++)
                {
                    <tr>
                        <td>
                            <input list="medicineList"
                                   name="Medicines[@i].ProductId"
                                   class="form-control"
                                   value="@(Model.Medicines?[i]?.ProductId ?? 0)" />
                            <datalist id="medicineList">
                                @foreach (var med in Model.MedicineList)
                                {
                                    <option value="@med.ProductCode">@med.ProductName</option>
                                }
                            </datalist>
                        </td>

                        <td>
                            <input list="doseList"
                                   name="Medicines[@i].DosePatternId"
                                   class="form-control"
                                   value="@(Model.Medicines?[i]?.DosePatternId ?? 0)" />
                            <datalist id="doseList">
                                @foreach (var dp in Model.DosePatternList)
                                {
                                    <option value="@dp.DosePatternId">@dp.DoseDescription</option>
                                }
                            </datalist>
                        </td>

                        <td>
                            <input asp-for="Medicines[@i].DoseUsage" class="form-control" />
                        </td>

                        <td>
                            <input asp-for="Medicines[@i].DoseDays" type="number" class="form-control" />
                        </td>

                        <td>
                            <input asp-for="Medicines[@i].Qty" type="number" class="form-control" />
                        </td>

                        <td class="text-center">
                            <button type="button" class="btn btn-danger btn-small" onclick="removeRow(this)">X</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <button type="button" class="btn btn-success btn-sm" onclick="addMedicine()">+ Add Medicine</button>
    </div>

    <!-- ===================== Clinical Section ===================== -->
    <div class="section-block">
        <div class="section-title">Clinical Details</div>
        <table class="table table-bordered grid-table" id="clinicalTable">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Result</th>
                    <th width="40">#</th>
                </tr>
            </thead>
            <tbody id="clinicalRows">
                <tr>
                    <td><input name="Clinical[0].ClinicalNote" class="form-control" /></td>
                    <td><input name="Clinical[0].Result" class="form-control" /></td>
                    <td><button type="button" class="btn btn-danger btn-small" onclick="removeRow(this)">X</button></td>
                </tr>
            </tbody>
        </table>
        <button type="button" class="btn btn-sm btn-success" onclick="addClinical()">+ Add Clinical Row</button>
    </div>

    <!-- Submit -->
    <button type="submit" class="btn btn-primary btn-lg">Save</button>

</form>

<script>
    function removeRow(btn) {
        btn.closest("tr").remove();
    }

    function addMedicine() {
        let index = document.querySelectorAll("#medicineRows tr").length;
        let row = `
            <tr>
                <td><input list="medicineList" name="Medicines[${index}].ProductId" class="form-control" /></td>
                <td><input list="doseList" name="Medicines[${index}].DosePatternId" class="form-control" /></td>
                <td><input name="Medicines[${index}].DoseUsage" class="form-control" /></td>
                <td><input name="Medicines[${index}].DoseDays" type="number" class="form-control" /></td>
                <td><input name="Medicines[${index}].Qty" type="number" class="form-control" /></td>
                <td><button type="button" class="btn btn-danger btn-small" onclick="removeRow(this)">X</button></td>
            </tr>`;
        document.getElementById("medicineRows").insertAdjacentHTML('beforeend', row);
    }

    function addClinical() {
        let index = document.querySelectorAll("#clinicalRows tr").length;
        let row = `
            <tr>
                <td><input name="Clinical[${index}].ClinicalNote" class="form-control" /></td>
                <td><input name="Clinical[${index}].Result" class="form-control" /></td>
                <td><button type="button" class="btn btn-danger btn-small" onclick="removeRow(this)">X</button></td>
            </tr>`;
        document.getElementById("clinicalRows").insertAdjacentHTML('beforeend', row);
    }
</script>
